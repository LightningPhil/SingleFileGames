<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeNebula | Ultimate Analyzer</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <style>
        :root {
            --bg-dark: #050510;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #00f2ff;
            --secondary: #bc13fe;
            --text-main: #e0e0e0;
            --text-muted: #8a8a9b;
        }

        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--primary) var(--bg-dark); }
        
        body {
            margin: 0;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(5, 5, 16, 0.9), rgba(5, 5, 16, 0.9)),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23bc13fe' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- UI STYLES --- */
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; margin: 0; text-transform: uppercase; letter-spacing: 2px; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header {
            display: flex; justify-content: space-between; align-items: center; padding: 30px 0;
            border-bottom: 1px solid var(--glass-border); margin-bottom: 40px;
        }
        .logo { font-size: 2rem; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; text-shadow: 0 0 20px rgba(0, 242, 255, 0.3); }

        /* Upload */
        #upload-section {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 60vh; border: 2px dashed var(--glass-border); border-radius: 20px;
            background: var(--glass); transition: all 0.3s ease; position: relative;
        }
        #upload-section:hover, #upload-section.dragover { border-color: var(--primary); box-shadow: 0 0 30px rgba(0, 242, 255, 0.1); }
        .upload-btn {
            padding: 15px 40px; font-size: 1.2rem; background: transparent; border: 2px solid var(--primary);
            color: var(--primary); border-radius: 5px; cursor: pointer; font-family: 'Orbitron', sans-serif;
            transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .upload-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }

        /* Dashboard */
        #dashboard { display: none; animation: fadeIn 1s ease; }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .card {
            background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 20px; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(to bottom, var(--primary), var(--secondary)); }
        .stat-value { font-size: 2.2rem; font-weight: 700; font-family: 'Orbitron', sans-serif; color: #fff; margin: 10px 0; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Quick Actions */
        .actions-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .action-btn {
            flex: 1; padding: 15px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.02);
            color: var(--text-muted); font-family: 'Orbitron'; font-size: 0.9rem; text-transform: uppercase;
            cursor: not-allowed; transition: 0.3s; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .action-btn.active {
            border-color: var(--primary); color: #fff; cursor: pointer; background: rgba(0, 242, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }
        .action-btn.active:hover { background: var(--primary); color: #000; }
        .action-btn.active-sec { border-color: var(--secondary); background: rgba(188, 19, 254, 0.1); }
        .action-btn.active-sec:hover { background: var(--secondary); color: #fff; }

        /* Charts */
        .charts-row { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { position: relative; height: 350px; display: flex; align-items: center; justify-content: center; }

        /* Table */
        .file-browser { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; max-height: 600px; display: flex; flex-direction: column; }
        .table-header { padding: 15px 25px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; }
        .table-scroll { overflow-y: auto; }
        
        table { width: 100%; border-collapse: collapse; }
        th { 
            text-align: left; padding: 15px 25px; color: var(--primary); font-family: 'Orbitron'; font-size: 0.8rem; 
            position: sticky; top: 0; background: #08081a; z-index: 10; cursor: pointer; user-select: none;
            border-bottom: 2px solid var(--glass-border);
        }
        th:hover { color: #fff; background: rgba(0, 242, 255, 0.1); }
        th span.sort-icon { margin-left: 5px; font-size: 0.7em; }
        
        td { padding: 10px 25px; border-bottom: 1px solid var(--glass-border); font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: #ccc; white-space: nowrap; }
        .path-cell { color: var(--text-muted); font-size: 0.8rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; }
        
        tr { cursor: pointer; transition: 0.2s; }
        tr:hover { background: rgba(0, 242, 255, 0.05); }
        tr:hover td:first-child { color: var(--primary); }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; background: rgba(188, 19, 254, 0.2); border: 1px solid rgba(188, 19, 254, 0.4); color: #fff; text-transform: uppercase; }

        /* Modal */
        #file-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #1e1e2e; width: 85%; height: 85%; border-radius: 4px; border: 1px solid var(--primary);
            display: flex; flex-direction: column; box-shadow: 0 0 60px rgba(0, 242, 255, 0.15);
        }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #151520; }
        .modal-body { flex: 1; overflow: auto; padding: 0; background: #282c34; }
        .modal-body pre { margin: 0; padding: 20px; font-size: 0.9rem; }
        .close-btn { color: var(--secondary); font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .close-btn:hover { color: #fff; transform: scale(1.1); }

        /* PDF Button */
        .pdf-btn {
            position: fixed; bottom: 30px; right: 30px; background: var(--secondary); color: #fff;
            padding: 0; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 0 20px rgba(188, 19, 254, 0.5); border: none; font-size: 1.5rem; transition: 0.3s; z-index: 100;
        }
        .pdf-btn:hover { transform: scale(1.1) rotate(-10deg); box-shadow: 0 0 30px var(--secondary); background: #d34dff; }
        .pdf-btn.processing { animation: pulse 1s infinite; background: #555; pointer-events: none; }

        /* Loader */
        .loader {
            display: none; border: 4px solid rgba(255,255,255,0.1); border-left: 4px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

<div class="container" id="main-content">
    <header>
        <div class="logo">CODENEBULA <span style="font-size: 0.5em; color: var(--text-muted); font-family: 'Rajdhani'">// ULTIMATE ANALYZER</span></div>
        <div style="font-family: 'Roboto Mono'; font-size: 0.8rem; color: var(--primary);">SYSTEM: <span style="color:#fff">ONLINE</span></div>
    </header>

    <!-- Upload View -->
    <div id="upload-section" onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" accept=".zip">
        <div class="loader" id="loader"></div>
        <div id="upload-text" style="text-align: center;">
            <h2 style="margin-bottom: 20px; color: #fff;">Initialize Analysis</h2>
            <button class="upload-btn">Upload Project ZIP</button>
            <p style="margin-top: 20px; color: var(--text-muted); font-family: 'Roboto Mono'; font-size: 0.8rem;">[ DRAG & DROP SUPPORTED ]</p>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard">
        
        <!-- Key Metrics -->
        <div class="grid">
            <div class="card">
                <div class="stat-label">Total Files</div>
                <div class="stat-value" id="total-files">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Total Lines of Code</div>
                <div class="stat-value" id="total-loc">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Project Size</div>
                <div class="stat-value" id="total-size">0 MB</div>
            </div>
            <div class="card">
                <div class="stat-label">Dominate Language</div>
                <div class="stat-value" id="top-lang" style="color: var(--primary)">-</div>
            </div>
        </div>

        <!-- Documentation Access -->
        <div class="actions-row">
            <div id="btn-readme" class="action-btn" onclick="openFoundFile('readme')">
                <span>üìÑ View Readme</span>
            </div>
            <div id="btn-license" class="action-btn" onclick="openFoundFile('license')">
                <span>‚öñÔ∏è View License</span>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-row">
            <div class="card">
                <h3 style="font-size: 1rem; margin-bottom: 15px; color: var(--primary);">Composition</h3>
                <div class="chart-container">
                    <canvas id="sizeChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 style="font-size: 1rem; margin-bottom: 15px; color: var(--secondary);">File Type Distribution</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- File Browser -->
        <div class="file-browser">
            <div class="table-header">
                <h3>File Matrix</h3>
                <input type="text" id="search-box" placeholder="SEARCH FILENAME OR PATH..." style="background: rgba(255,255,255,0.1); border:none; padding: 10px 15px; color: white; border-radius: 4px; font-family: 'Roboto Mono'; width: 250px; border: 1px solid var(--glass-border); color: var(--primary);">
            </div>
            <div class="table-scroll">
                <table id="file-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('name')" style="width: 25%">Filename <span class="sort-icon" id="sort-name"></span></th>
                            <th onclick="sortTable('directory')" style="width: 35%">Location <span class="sort-icon" id="sort-directory"></span></th>
                            <th onclick="sortTable('extension')" style="width: 10%">Type <span class="sort-icon" id="sort-extension"></span></th>
                            <th onclick="sortTable('size')" style="width: 15%">Size <span class="sort-icon" id="sort-size">‚ñº</span></th>
                            <th onclick="sortTable('lines')" style="width: 15%">Lines <span class="sort-icon" id="sort-lines"></span></th>
                        </tr>
                    </thead>
                    <tbody id="file-list">
                        <!-- JS Populates this -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="file-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modal-filename" style="font-family: 'Roboto Mono'; color: var(--primary); font-weight: bold;">filename.js</span>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <pre><code id="code-content"></code></pre>
        </div>
    </div>
</div>

<button class="pdf-btn" id="pdf-btn" onclick="generateDirectPDF()" title="Download PDF Report">
    ‚¨á
</button>

<script>
    // --- State ---
    const { jsPDF } = window.jspdf;
    let filesData = []; 
    let zipContent = null;
    let sizeChartInstance = null;
    let barChartInstance = null;
    let typeStats = {};
    let globalStats = {};
    
    // Found Docs
    let readmeFound = null; // Stores file object
    let licenseFound = null; // Stores file object
    let readmeSnippet = ""; // For PDF
    let licenseSnippet = ""; // For PDF

    let currentSort = { key: 'size', order: 'desc' };

    // --- DOM Elements ---
    const uploadSection = document.getElementById('upload-section');
    const dashboard = document.getElementById('dashboard');
    const loader = document.getElementById('loader');
    const uploadText = document.getElementById('upload-text');
    const fileInput = document.getElementById('file-input');
    const searchBox = document.getElementById('search-box');
    const btnReadme = document.getElementById('btn-readme');
    const btnLicense = document.getElementById('btn-license');

    // --- Event Listeners ---
    fileInput.addEventListener('change', handleFile);
    
    uploadSection.addEventListener('dragover', (e) => { e.preventDefault(); uploadSection.classList.add('dragover'); });
    uploadSection.addEventListener('dragleave', () => { uploadSection.classList.remove('dragover'); });
    uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile({ target: { files: e.dataTransfer.files } });
    });

    searchBox.addEventListener('input', applySortAndFilter);

    // --- Main Logic ---

    async function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        uploadText.style.display = 'none';
        loader.style.display = 'block';

        try {
            const zip = new JSZip();
            zipContent = await zip.loadAsync(file);
            filesData = [];
            typeStats = {};
            readmeFound = null;
            licenseFound = null;
            readmeSnippet = "";
            licenseSnippet = "";

            let totalSize = 0;
            let totalLines = 0;
            let maxDepth = 0;
            let maxDepthPath = "";

            const entries = Object.keys(zipContent.files);
            
            for (let fullPath of entries) {
                const entry = zipContent.files[fullPath];
                if (entry.dir) continue;

                // Path Processing
                const pathParts = fullPath.split('/');
                const fileName = pathParts.pop();
                const directory = pathParts.length > 0 ? pathParts.join('/') + '/' : './';
                const extension = fileName.includes('.') ? fileName.split('.').pop().toLowerCase() : 'unknown';
                
                // Detection Logic
                const lowerName = fileName.toLowerCase();
                
                if (lowerName.startsWith('readme')) {
                    if (!readmeFound || fullPath.length < readmeFound.path.length) { // Prefer root
                        readmeFound = { path: fullPath, name: fileName, extension: extension, isText: true };
                        // Fetch for PDF Snippet
                        try {
                            const text = await entry.async("string");
                            const lines = text.split(/\r\n|\r|\n/);
                            readmeSnippet = lines.slice(0, 10).join('\n');
                        } catch(e) {}
                    }
                }
                
                if (lowerName.startsWith('license') || lowerName.startsWith('copying')) {
                    if (!licenseFound || fullPath.length < licenseFound.path.length) {
                        licenseFound = { path: fullPath, name: fileName, extension: extension, isText: true };
                         // Fetch for PDF Snippet
                        try {
                            const text = await entry.async("string");
                            const lines = text.split(/\r\n|\r|\n/);
                            licenseSnippet = lines.slice(0, 5).join('\n');
                        } catch(e) {}
                    }
                }

                // Depth
                if (pathParts.length > maxDepth) {
                    maxDepth = pathParts.length;
                    maxDepthPath = directory;
                }

                // Stats
                const size = entry._data.uncompressedSize;
                totalSize += size;

                // Line Counting
                const isText = ['js', 'html', 'css', 'json', 'py', 'java', 'c', 'cpp', 'h', 'php', 'rb', 'ts', 'jsx', 'tsx', 'md', 'txt', 'xml', 'yml', 'sql', 'vue', 'go', 'rs', 'sh', 'bat', 'conf'].includes(extension);
                
                let lineCount = 0;
                if (isText && size < 1000000) { 
                    try {
                        const text = await entry.async("string");
                        lineCount = text.split(/\r\n|\r|\n/).length;
                        totalLines += lineCount;
                    } catch (err) { lineCount = 0; }
                }

                typeStats[extension] = (typeStats[extension] || 0) + 1;

                filesData.push({
                    path: fullPath,
                    name: fileName,
                    directory: directory,
                    extension: extension,
                    size: size,
                    lines: isText ? lineCount : 0,
                    isText: isText
                });
            }

            // Global Stats for Report
            let topLang = Object.entries(typeStats).sort((a,b) => b[1] - a[1]);
            const dominantLang = topLang.length ? topLang[0][0].toUpperCase() : '-';
            const avgSize = filesData.length ? Math.round(totalSize / filesData.length) : 0;
            
            globalStats = {
                totalFiles: filesData.length,
                totalLines: totalLines,
                totalSize: totalSize,
                dominantLang: dominantLang,
                avgSize: avgSize,
                maxDepthPath: maxDepthPath || "./"
            };

            // Update UI
            document.getElementById('total-files').innerText = filesData.length;
            document.getElementById('total-loc').innerText = totalLines.toLocaleString();
            document.getElementById('total-size').innerText = formatBytes(totalSize);
            document.getElementById('top-lang').innerText = dominantLang;

            // Buttons State
            if (readmeFound) {
                btnReadme.classList.add('active');
                btnReadme.onclick = () => openFoundFile('readme');
            } else {
                btnReadme.classList.remove('active');
                btnReadme.onclick = null;
            }

            if (licenseFound) {
                btnLicense.classList.add('active', 'active-sec');
                btnLicense.onclick = () => openFoundFile('license');
            } else {
                btnLicense.classList.remove('active', 'active-sec');
                btnLicense.onclick = null;
            }

            renderCharts(filesData, typeStats);
            applySortAndFilter(); 

            uploadSection.style.display = 'none';
            dashboard.style.display = 'block';

        } catch (err) {
            console.error(err);
            alert("Error parsing ZIP file.");
            uploadText.style.display = 'block';
            loader.style.display = 'none';
        }
    }

    // --- Actions ---
    function openFoundFile(type) {
        if (type === 'readme' && readmeFound) openFile(readmeFound);
        if (type === 'license' && licenseFound) openFile(licenseFound);
    }

    // --- Sort/Filter/Render ---
    function sortTable(key) {
        if (currentSort.key === key) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.key = key;
            currentSort.order = (key === 'size' || key === 'lines') ? 'desc' : 'asc';
        }
        applySortAndFilter();
    }

    function applySortAndFilter() {
        const term = searchBox.value.toLowerCase();
        let result = filesData.filter(f => 
            f.name.toLowerCase().includes(term) || 
            f.directory.toLowerCase().includes(term)
        );

        result.sort((a, b) => {
            let valA = a[currentSort.key];
            let valB = b[currentSort.key];
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();

            if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
            return 0;
        });

        document.querySelectorAll('.sort-icon').forEach(el => el.innerText = '');
        const arrow = currentSort.order === 'asc' ? '‚ñ≤' : '‚ñº';
        document.getElementById(`sort-${currentSort.key}`).innerText = arrow;

        renderTable(result);
    }

    function renderTable(data) {
        const tbody = document.getElementById('file-list');
        tbody.innerHTML = '';
        const limit = 200; 
        const renderData = data.slice(0, limit);

        renderData.forEach(file => {
            const tr = document.createElement('tr');
            tr.onclick = () => openFile(file);
            tr.innerHTML = `
                <td style="font-weight:bold; color: #fff;">${file.name}</td>
                <td class="path-cell" title="${file.directory}">${file.directory}</td>
                <td><span class="badge">${file.extension}</span></td>
                <td style="font-family:'Orbitron'; color: var(--primary)">${formatBytes(file.size)}</td>
                <td>${file.isText ? file.lines.toLocaleString() : '-'}</td>
            `;
            tbody.appendChild(tr);
        });

        if(data.length > limit) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="5" style="text-align:center; color: var(--text-muted); padding: 20px;">+${data.length - limit} more files hidden (use search)</td>`;
            tbody.appendChild(tr);
        }
    }

    // --- Charts ---
    function renderCharts(files, types) {
        const topFiles = files.slice().sort((a,b) => b.size - a.size).slice(0, 5);
        const othersSize = files.reduce((acc, curr) => acc + curr.size, 0) - topFiles.reduce((acc, curr) => acc + curr.size, 0);
        
        const labels = topFiles.map(f => f.name.length > 15 ? f.name.substring(0,12)+'...' : f.name);
        labels.push('Others');
        const data = topFiles.map(f => f.size);
        data.push(othersSize);

        const ctxPie = document.getElementById('sizeChart').getContext('2d');
        if(sizeChartInstance) sizeChartInstance.destroy();

        sizeChartInstance = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#00f2ff', '#bc13fe', '#4d4dff', '#ff0055', '#ffff00', '#333'],
                    borderColor: '#050510', borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: '#e0e0e0', font: {family: 'Rajdhani'} } } }
            }
        });

        const sortedTypes = Object.entries(types).sort((a,b) => b[1] - a[1]).slice(0, 10);
        const ctxBar = document.getElementById('barChart').getContext('2d');
        if(barChartInstance) barChartInstance.destroy();

        barChartInstance = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: sortedTypes.map(t => '.' + t[0]),
                datasets: [{
                    label: 'Count', data: sortedTypes.map(t => t[1]),
                    backgroundColor: 'rgba(188, 19, 254, 0.5)', borderColor: '#bc13fe', borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#8a8a9b' } },
                    x: { grid: { display: false }, ticks: { color: '#8a8a9b' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- Modal ---
    async function openFile(fileData) {
        if (!fileData.isText) { alert("Binary file cannot be viewed."); return; }
        const modal = document.getElementById('file-modal');
        const codeBlock = document.getElementById('code-content');
        document.getElementById('modal-filename').innerText = fileData.name;
        codeBlock.innerText = "Accessing Neural Databanks...";
        codeBlock.className = ''; 
        modal.style.display = 'flex';

        try {
            const content = await zipContent.files[fileData.path].async("string");
            codeBlock.textContent = content;
            codeBlock.className = `language-${fileData.extension}`;
            hljs.highlightElement(codeBlock);
        } catch (e) { codeBlock.innerText = "Error reading file."; }
    }
    function closeModal() { document.getElementById('file-modal').style.display = 'none'; }
    window.onclick = function(event) { if (event.target == document.getElementById('file-modal')) closeModal(); }

    // --- PDF GENERATION ENGINE ---

    function generateDirectPDF() {
        const btn = document.getElementById('pdf-btn');
        btn.classList.add('processing');
        
        setTimeout(() => {
            try {
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 10;
                let cursorY = 15;
                const lineHeight = 4;
                const maxLineWidth = 180; // A4 width approx 210, minus margins

                // Font Setup
                doc.setFont("Courier", "normal");
                doc.setFontSize(9);

                // --- Helpers ---
                const addLine = (text) => {
                    // Check for page break
                    if (cursorY > pageHeight - margin) {
                        doc.addPage();
                        cursorY = 15;
                    }
                    doc.text(text, margin, cursorY);
                    cursorY += lineHeight;
                };

                // Wrapper for long text (returns array of strings)
                const wrapText = (text) => doc.splitTextToSize(text, maxLineWidth);

                const addSeparator = () => addLine("+".padEnd(95, "-") + "+");
                const addEmpty = () => addLine("|".padEnd(95, " ") + "|");
                const centerText = (txt) => {
                    const spaces = Math.floor((95 - txt.length) / 2);
                    return "|" + " ".repeat(spaces) + txt + " ".repeat(95 - spaces - txt.length - 1) + "|";
                };

                // --- 1. HEADER ---
                addSeparator();
                addEmpty();
                addLine(centerText("C O D E   N E B U L A   A N A L Y S I S"));
                addLine(centerText("PROJECT INTELLIGENCE REPORT"));
                addEmpty();
                addSeparator();
                cursorY += 5;

                // --- 2. GLOBAL STATS ---
                addLine(" [ EXECUTIVE SUMMARY ]");
                addLine(" ".padEnd(95, "="));
                addLine(`  DATE GENERATED  : ${new Date().toLocaleString()}`);
                addLine(`  TOTAL FILES     : ${globalStats.totalFiles.toString().padEnd(25)} TOTAL SIZE    : ${formatBytes(globalStats.totalSize)}`);
                addLine(`  TOTAL LINES     : ${globalStats.totalLines.toLocaleString().padEnd(25)} AVG FILE SIZE : ${formatBytes(globalStats.avgSize)}`);
                addLine(`  DOMINANT LANG   : ${globalStats.dominantLang.padEnd(25)}`);
                cursorY += 2;
                
                // Deepest Path - Wrapped
                addLine("  DEEPEST PATH    :");
                const wrappedPath = wrapText("  " + globalStats.maxDepthPath);
                wrappedPath.forEach(line => addLine(line));
                
                cursorY += 5;

                // --- 3. DOCUMENTATION SNIPPETS ---
                if (readmeSnippet || licenseSnippet) {
                    addLine(" [ PROJECT DOCUMENTATION ]");
                    addLine(" ".padEnd(95, "="));
                    
                    if (readmeSnippet) {
                        addLine(`  README (${readmeFound.name}) - FIRST 10 LINES:`);
                        addLine("  ---------------------------------------------");
                        const readmeLines = wrapText(readmeSnippet);
                        readmeLines.forEach(l => addLine("  " + l));
                        cursorY += 4;
                    }

                    if (licenseSnippet) {
                        addLine(`  LICENSE (${licenseFound.name}) - FIRST 5 LINES:`);
                        addLine("  ----------------------------------------------");
                        const licenseLines = wrapText(licenseSnippet);
                        licenseLines.forEach(l => addLine("  " + l));
                        cursorY += 4;
                    }
                }

                // --- 4. BAR CHART ASCII ---
                addLine(" [ FILE COMPOSITION ]");
                addLine(" ".padEnd(95, "="));
                
                const sortedTypes = Object.entries(typeStats).sort((a,b) => b[1] - a[1]);
                const maxCount = sortedTypes[0] ? sortedTypes[0][1] : 1;

                sortedTypes.slice(0, 10).forEach(([type, count]) => {
                    const label = ('.' + type).toUpperCase().padEnd(8);
                    const barLen = Math.floor((count / maxCount) * 50);
                    const bar = "=".repeat(barLen) + " ".repeat(50 - barLen);
                    const percent = ((count / globalStats.totalFiles) * 100).toFixed(1) + "%";
                    addLine(`  ${label} |${bar}| ${count} (${percent})`);
                });
                cursorY += 5;

                // --- 5. LARGEST FILES ---
                addLine(" [ TOP LARGEST FILES ]");
                addLine(" ".padEnd(95, "="));
                addLine("  SIZE        | LINES   | PATH");
                addLine("  ------------+---------+---------------------------------------------------");
                
                const largestFiles = filesData.slice().sort((a,b) => b.size - a.size).slice(0, 8);
                largestFiles.forEach(f => {
                    const s = formatBytes(f.size).padEnd(12);
                    const l = (f.isText ? f.lines : '-').toString().padEnd(8);
                    
                    // Wrap the path column
                    const pathLines = doc.splitTextToSize(f.path, 110); // remaining width
                    addLine(`  ${s}| ${l}| ${pathLines[0]}`);
                    // indent subsequent lines
                    for(let i=1; i<pathLines.length; i++) {
                         addLine(`              |         | ${pathLines[i]}`);
                    }
                });
                cursorY += 5;

                // --- 6. FULL TABLE ---
                addLine(" [ FILE MANIFEST - SORTED BY PATH ]");
                addLine(" ".padEnd(95, "="));
                
                // Header
                const hName = "FILENAME".padEnd(30);
                const hType = "TYPE".padEnd(8);
                const hSize = "SIZE".padEnd(10);
                const hLoc  = "LOC".padEnd(8);
                const hPath = "DIRECTORY";
                
                addLine(`  ${hName}${hType}${hSize}${hLoc}${hPath}`);
                addLine("  " + "-".repeat(30) + " " + "-".repeat(8) + " " + "-".repeat(10) + " " + "-".repeat(8) + " " + "-".repeat(30));

                const sortedByPath = filesData.slice().sort((a,b) => a.path.localeCompare(b.path));
                
                sortedByPath.forEach(f => {
                    let n = f.name;
                    if(n.length > 28) n = n.substring(0, 25) + "...";
                    n = n.padEnd(30);

                    const t = f.extension.toUpperCase().substring(0,7).padEnd(8);
                    const s = formatBytes(f.size).padEnd(10);
                    const l = (f.isText ? f.lines : '-').toString().padEnd(8);
                    
                    // Directory Wrap
                    const dirLines = doc.splitTextToSize(f.directory, 80);
                    addLine(`  ${n}${t}${s}${l}${dirLines[0]}`);
                     for(let i=1; i<dirLines.length; i++) {
                         addLine(`  ${" ".repeat(30)}${" ".repeat(8)}${" ".repeat(10)}${" ".repeat(8)}${dirLines[i]}`);
                    }
                });

                // Footer
                doc.setFontSize(8);
                const footerText = "Generated by CodeNebula // " + new Date().toISOString();
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.text(footerText, margin, pageHeight - 5);
                    doc.text(`PAGE ${i} OF ${totalPages}`, pageWidth - margin - 20, pageHeight - 5);
                }

                doc.save('CodeNebula-Report.pdf');

            } catch (err) {
                console.error(err);
                alert("Error generating PDF.");
            } finally {
                btn.classList.remove('processing');
            }
        }, 100);
    }

    // --- Utilities ---
    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }
</script>
</body>
</html>