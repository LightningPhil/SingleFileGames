<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whack-A-Zoo</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap');

        :root {
            /* Vibrant Zoo Gradient */
            --bg-gradient: radial-gradient(circle at center, #81ecec 0%, #00cec9 100%);
            --primary: #fdcb6e;
            --text: #2d3436;
            --hole-bg: #3e2723;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            font-family: 'Nunito', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            cursor: crosshair;
        }

        /* --- Header --- */
        header {
            text-align: center;
            padding-top: 15px;
            height: 90px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            margin: 0;
            color: #fff;
            text-shadow: 0 4px 0 rgba(0,0,0,0.2);
            letter-spacing: 1px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .stat-box {
            background: #fff;
            padding: 5px 20px;
            border-radius: 50px;
            font-size: 1.2rem;
            color: var(--text);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            font-weight: 800;
            min-width: 100px;
            text-align: center;
        }

        /* --- Game Grid --- */
        .game-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding-bottom: 20px;
        }

        .row {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 20px 0;
        }

        /* --- The Hole --- */
        .hole {
            position: relative;
            width: 150px;
            height: 180px; 
            margin: 0 10px;
            overflow: hidden; 
            background: var(--hole-bg);
            border-radius: 75px 75px 20px 20px;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.5);
            border-bottom: 5px solid rgba(255,255,255,0.1);
        }

        /* --- The Animal Container --- */
        .animal-container {
            position: absolute;
            left: 50%;
            width: 140px;
            height: 320px; 
            top: 180px; /* Start hidden */
            transform: translateX(-50%);
            transition: top 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1;
        }

        .hole.up .animal-container {
            top: 15px; 
            cursor: pointer;
        }

        .hole.bonked .animal-container {
            top: 40px; 
            transition: top 0.1s ease-out;
            pointer-events: none;
        }

        /* --- Dirt Foreground --- */
        .dirt-container {
            position: absolute;
            bottom: -15px; 
            left: -10%;
            width: 120%;
            height: 60px;
            z-index: 2;
            pointer-events: none;
        }

        /* --- Animations & Visibility --- */
        .eyes-cross, .tongue-group, .spit-particle { display: none; }
        .acc-party, .acc-crown { display: none; }
        
        .animal-container.type-party .acc-party { display: block; }
        .animal-container.type-crown .acc-crown { display: block; }

        .hole.bonked .eyes-normal { display: none; }
        .hole.bonked .eyes-cross { display: block; }
        
        .hole.bonked .snout-wrapper {
            animation: snout-puff 0.1s infinite alternate;
            transform-origin: center center;
        }
        
        .hole.bonked .tongue-group {
            display: block;
            animation: raspberry-tongue 0.08s infinite; 
            transform-origin: center top; 
        }

        .hole.bonked .spit-particle {
            display: block;
            animation: spit-fly 0.3s infinite;
        }

        @keyframes snout-puff {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        @keyframes raspberry-tongue {
            0% { transform: scaleY(0.5) rotate(0deg); }
            25% { transform: scaleY(1.4) rotate(-10deg) scaleX(1.2); }
            50% { transform: scaleY(1.2) rotate(0deg) scaleX(1.1); }
            75% { transform: scaleY(1.4) rotate(10deg) scaleX(1.2); }
            100% { transform: scaleY(0.5) rotate(0deg); }
        }

        @keyframes spit-fly {
            0% { transform: translate(0,0) scale(0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(1); opacity: 0; }
        }

        /* --- Floating Score --- */
        .float-score {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: #fff;
            pointer-events: none;
            animation: floatUp 0.6s forwards;
            z-index: 100;
            text-shadow: 2px 2px 0 #000;
        }
        
        .float-score.score-2 { color: #fdcb6e; }
        .float-score.score-3 { color: #fab1a0; }
        .float-score.score-6 { color: #74b9ff; font-size: 3rem; }
        .float-score.score-9 { color: #d63031; font-size: 4rem; text-shadow: 3px 3px 0 #fff; }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.2); }
        }

        /* --- OVERLAY --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; }
        
        .overlay h2 {
            color: white; 
            font-family:'Fredoka One'; 
            font-size: 3.5rem; 
            margin: 0 0 20px 0;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .btn {
            background: var(--primary);
            border: 4px solid #fff;
            padding: 15px 50px;
            font-size: 2rem;
            font-family: 'Fredoka One', cursive;
            color: #2d3436;
            border-radius: 60px;
            cursor: pointer;
            box-shadow: 0 8px 0 #b78e36;
            transition: all 0.1s;
        }
        .btn:active { transform: translateY(8px); box-shadow: none; }

        .leaderboard-container {
            background: white;
            padding: 20px;
            border-radius: 20px;
            width: 300px;
            text-align: center;
            margin-bottom: 20px;
        }
        .leaderboard-list { list-style: none; padding: 0; margin: 0; font-size: 1.2rem; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .input-group { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        input#username { padding: 15px; font-size: 1.5rem; border-radius: 10px; border: none; text-align: center; font-family: 'Nunito'; font-weight: bold; outline: none; }
        
        @media (max-width: 900px) {
            .hole { width: 100px; height: 140px; margin: 0 4px; }
            .animal-container { width: 100px; height: 250px; top: 140px; }
            .hole.up .animal-container { top: 10px; }
            .hole.bonked .animal-container { top: 30px; }
            .dirt-container { height: 40px; bottom: -10px; }
            .row { margin: 15px 0; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Whack-A-Zoo</h1>
        <div class="stats-bar">
            <div class="stat-box">Score: <span id="score">0</span></div>
            <div class="stat-box">Time: <span id="timer">60</span>s</div>
            <div class="stat-box" style="color:#e17055">Best: <span id="high-score">0</span></div>
        </div>
    </header>

    <div class="game-wrapper">
        <div class="row">
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
        </div>
        <div class="row">
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
            <div class="hole"><div class="animal-container"></div><div class="dirt-container"></div></div>
        </div>
    </div>

    <div class="overlay" id="overlay">
        <div id="start-content">
            <h2>Ready?</h2>
            <button class="btn" onclick="startGame()">PLAY!</button>
        </div>
        <div id="input-content" style="display:none;" class="input-group">
            <h2>NEW HIGH SCORE!</h2>
            <input type="text" id="username" placeholder="Enter Name" maxlength="8">
            <button class="btn" onclick="submitScore()">SAVE</button>
        </div>
        <div id="leaderboard-content" style="display:none; text-align: center;">
            <h2>GAME OVER</h2>
            <div class="leaderboard-container">
                <h3 style="font-family:'Fredoka One'; margin-bottom:10px;">ZOO KEEPERS</h3>
                <ul class="leaderboard-list" id="leaderboard-list"></ul>
            </div>
            <button class="btn" onclick="resetToStart()">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            GAME_DURATION: 60, 
            START_MIN_TIME: 810, 
            START_MAX_TIME: 1440, 
            END_MIN_TIME_LIMIT: 270, 
            END_MAX_TIME_LIMIT: 540, 
            SPEED_DECREMENT: 15,
            PROB_CROWN: 1 / 11,
            PROB_PARTY: 1 / 5,
            MOD_PARTY_TIME: 0.75, 
            MOD_CROWN_TIME: 0.5   
        };

        // --- ASSET GENERATOR (High Quality SVGs) ---
        function getAnimalSVG(type) {
            let svgContent = '';
            let hatY = -50; 

            // Standard Parts
            const accessories = `
                <g class="acc-party" transform="translate(15, HAT_Y) rotate(15)">
                    <path d="M-15,10 L0,-40 L15,10 Z" fill="#74b9ff" stroke="#0984e3" stroke-width="2"/>
                    <circle cx="0" cy="-40" r="4" fill="#ff7675"/>
                </g>
                <g class="acc-crown" transform="translate(0, HAT_Y_CROWN)">
                    <path d="M-20,10 L-20,-15 L-10,0 L0,-25 L10,0 L20,-15 L20,10 Z" fill="#ffd700" stroke="#b7950b" stroke-width="2"/>
                    <circle cx="0" cy="-25" r="3" fill="#d63031"/>
                </g>
            `;

            const mechanics = `
                <g class="tongue-group" transform="translate(0, 25)">
                        <path d="M-10,0 Q0,40 10,0" fill="#FF6B6B" stroke="#d63031" stroke-width="2" />
                        <path d="M0,0 L0,35" stroke="#d63031" stroke-width="1" fill="none"/>
                </g>
                <circle class="spit-particle" cx="-15" cy="40" r="3" fill="#74b9ff" style="--tx: -20px; --ty: 20px;" />
                <circle class="spit-particle" cx="15" cy="40" r="2" fill="#74b9ff" style="--tx: 20px; --ty: 15px;" />
                <g class="eyes-normal">
                    <circle cx="-14" cy="-10" r="6" fill="#2d3436"/>
                    <circle cx="-16" cy="-12" r="2" fill="white"/>
                    <circle cx="14" cy="-10" r="6" fill="#2d3436"/>
                    <circle cx="12" cy="-12" r="2" fill="white"/>
                </g>
                <g class="eyes-cross">
                    <path d="M-18,-14 L-10,-6 M-18,-6 L-10,-14" stroke="#2d3436" stroke-width="4" stroke-linecap="round"/>
                    <path d="M10,-14 L18,-6 M10,-6 L18,-14" stroke="#2d3436" stroke-width="4" stroke-linecap="round"/>
                </g>
            `;

            if (type === 'giraffe') {
                hatY = -50;
                svgContent = `
                    <path d="M-18,350 L-20,50 L20,50 L18,350 Z" fill="#F4D03F" />
                    <circle cx="-5" cy="100" r="10" fill="#D4AC0D" opacity="0.7"/>
                    <circle cx="8" cy="180" r="12" fill="#D4AC0D" opacity="0.7"/>
                    <g transform="translate(0, 50)">
                        ${accessories.replace('HAT_Y', -60).replace('HAT_Y_CROWN', -50)}
                        <ellipse cx="-28" cy="-10" rx="14" ry="8" fill="#F4D03F" transform="rotate(-20)"/>
                        <ellipse cx="28" cy="-10" rx="14" ry="8" fill="#F4D03F" transform="rotate(20)"/>
                        <path d="M-10,-28 L-14,-50" stroke="#F4D03F" stroke-width="7" stroke-linecap="round"/>
                        <circle cx="-14" cy="-50" r="6" fill="#B7950B"/>
                        <path d="M10,-28 L14,-50" stroke="#F4D03F" stroke-width="7" stroke-linecap="round"/>
                        <circle cx="14" cy="-50" r="6" fill="#B7950B"/>
                        <ellipse cx="0" cy="0" rx="32" ry="38" fill="#F4D03F"/>
                        <g class="snout-wrapper">
                            <ellipse cx="0" cy="18" rx="20" ry="16" fill="#F9E79F"/>
                            <circle cx="-7" cy="15" r="3" fill="#333"/>
                            <circle cx="7" cy="15" r="3" fill="#333"/>
                        </g>
                        ${mechanics}
                    </g>
                `;
            } else if (type === 'bunny') {
                hatY = -55;
                svgContent = `
                    <ellipse cx="-25" cy="-20" rx="12" ry="45" fill="#f5f6fa" stroke="#dcdde1" stroke-width="2" transform="rotate(-15)"/>
                    <ellipse cx="25" cy="-20" rx="12" ry="45" fill="#f5f6fa" stroke="#dcdde1" stroke-width="2" transform="rotate(15)"/>
                    <ellipse cx="-25" cy="-20" rx="6" ry="35" fill="#fab1a0" transform="rotate(-15)"/>
                    <ellipse cx="25" cy="-20" rx="6" ry="35" fill="#fab1a0" transform="rotate(15)"/>
                    <ellipse cx="0" cy="120" rx="45" ry="60" fill="#f5f6fa" />
                    <g transform="translate(0, 50)">
                        ${accessories.replace('HAT_Y', -65).replace('HAT_Y_CROWN', -55)}
                        <circle cx="0" cy="0" r="45" fill="#f5f6fa" />
                        <circle cx="-12" cy="15" r="14" fill="#fff"/>
                        <circle cx="12" cy="15" r="14" fill="#fff"/>
                        <path d="M-6,8 Q0,15 6,8 Q0,2 -6,8" fill="#ff7675" />
                        <rect x="-6" y="22" width="5" height="12" fill="white" stroke="#dfe6e9" rx="1"/>
                        <rect x="1" y="22" width="5" height="12" fill="white" stroke="#dfe6e9" rx="1"/>
                        <line x1="-20" y1="15" x2="-45" y2="10" stroke="#636e72" stroke-width="1"/>
                        <line x1="20" y1="15" x2="45" y2="10" stroke="#636e72" stroke-width="1"/>
                        <g class="snout-wrapper"></g>
                        ${mechanics}
                    </g>
                `;
            } else if (type === 'monkey') {
                hatY = -45;
                svgContent = `
                    <ellipse cx="0" cy="120" rx="40" ry="50" fill="#8D6E63" />
                    <g transform="translate(0, 50)">
                        ${accessories.replace('HAT_Y', -55).replace('HAT_Y_CROWN', -45)}
                        <circle cx="-35" cy="0" r="12" fill="#8D6E63"/>
                        <circle cx="-35" cy="0" r="8" fill="#D7CCC8"/>
                        <circle cx="35" cy="0" r="12" fill="#8D6E63"/>
                        <circle cx="35" cy="0" r="8" fill="#D7CCC8"/>
                        <circle cx="0" cy="0" r="35" fill="#8D6E63"/>
                        <path d="M-25,-10 Q0,-20 25,-10 Q28,15 15,25 Q0,35 -15,25 Q-28,15 -25,-10" fill="#D7CCC8"/>
                        <g class="snout-wrapper">
                             <ellipse cx="0" cy="15" rx="10" ry="8" fill="#D7CCC8"/>
                             <circle cx="-3" cy="14" r="1" fill="#333"/>
                             <circle cx="3" cy="14" r="1" fill="#333"/>
                        </g>
                        ${mechanics}
                    </g>
                `;
            } else if (type === 'rhino') {
                hatY = -50;
                svgContent = `
                    <ellipse cx="0" cy="120" rx="50" ry="60" fill="#B0BEC5" />
                    <g transform="translate(0, 50)">
                        ${accessories.replace('HAT_Y', -60).replace('HAT_Y_CROWN', -50)}
                        <path d="M-28,-20 L-35,-45 L-15,-30 Z" fill="#B0BEC5"/>
                        <path d="M28,-20 L35,-45 L15,-30 Z" fill="#B0BEC5"/>
                        <rect x="-35" y="-35" width="70" height="70" rx="25" fill="#B0BEC5"/>
                        <g class="snout-wrapper">
                            <path d="M-8,-15 L0,-50 L8,-15 Z" fill="#ECEFF1" stroke="#90A4AE" stroke-width="2"/>
                            <path d="M-3,5 L0,-5 L3,5 Z" fill="#ECEFF1" stroke="#90A4AE" stroke-width="1"/>
                        </g>
                        ${mechanics}
                    </g>
                `;
            } else if (type === 'dog') {
                hatY = -50;
                svgContent = `
                    <!-- Body -->
                    <ellipse cx="0" cy="120" rx="45" ry="55" fill="#E8F1F2" /> <!-- White Body -->
                    <path d="M-20,120 L20,120" stroke="#D35400" stroke-width="80" stroke-linecap="round" opacity="0.1"/> 
                    
                    <g transform="translate(0, 50)">
                        ${accessories.replace('HAT_Y', -60).replace('HAT_Y_CROWN', -50)}
                        
                        <!-- Floppy Ears -->
                        <path d="M-30,-20 C-50,-20 -60,0 -50,20 C-40,35 -30,25 -25,10" fill="#8B4513"/>
                        <path d="M30,-20 C50,-20 60,0 50,20 C40,35 30,25 25,10" fill="#8B4513"/>

                        <!-- Head Base -->
                        <circle cx="0" cy="0" r="38" fill="#E8F1F2"/> <!-- White Head -->
                        
                        <!-- Eye Patches -->
                        <ellipse cx="-12" cy="-8" rx="14" ry="18" fill="#8B4513" transform="rotate(-10)"/>
                        <ellipse cx="12" cy="-8" rx="14" ry="18" fill="#8B4513" transform="rotate(10)"/>

                        <!-- Collar -->
                        <rect x="-25" y="30" width="50" height="8" fill="#e74c3c" rx="2"/>
                        <circle cx="0" cy="38" r="4" fill="#f1c40f" stroke="#d35400" stroke-width="1"/>

                        <g class="snout-wrapper">
                            <ellipse cx="0" cy="15" rx="16" ry="12" fill="#fff"/>
                            <path d="M-8,10 Q0,18 8,10" fill="#333"/>
                            <ellipse cx="0" cy="8" rx="6" ry="4" fill="#333"/> <!-- Nose -->
                        </g>
                        ${mechanics}
                    </g>
                `;
            } else if (type === 'unicorn') {
                hatY = -65;
                svgContent = `
                    <path d="M-22,350 L-30,50 Q-40,20 -30,0 L25,50 L22,350 Z" fill="#a29bfe"/>
                    <path d="M-18,350 L-20,50 L20,50 L18,350 Z" fill="#ffffff" stroke="#dfe6e9" stroke-width="1"/>
                    <g transform="translate(0, 50)">
                        ${accessories.replace('HAT_Y', -75).replace('HAT_Y_CROWN', -65)}
                        <path d="M-20,-10 L-35,-40 L-10,-20 Z" fill="#ffffff" stroke="#dfe6e9" stroke-width="1"/>
                        <path d="M20,-10 L35,-40 L10,-20 Z" fill="#ffffff" stroke="#dfe6e9" stroke-width="1"/>
                        <path d="M-5,-25 L0,-80 L5,-25 Z" fill="#ffeaa7" stroke="#fdcb6e" stroke-width="2"/>
                        <ellipse cx="0" cy="0" rx="30" ry="40" fill="#ffffff"/>
                        <path d="M-10,-35 Q0,-50 10,-35 Q5,-20 0,-25 Q-5,-20 -10,-35" fill="#fd79a8"/>
                        <g class="snout-wrapper">
                            <ellipse cx="0" cy="20" rx="22" ry="18" fill="#ffcccc"/> 
                            <ellipse cx="-8" cy="18" rx="3" ry="5" fill="#636e72" transform="rotate(-10)"/> 
                            <ellipse cx="8" cy="18" rx="3" ry="5" fill="#636e72" transform="rotate(10)"/>
                        </g>
                        ${mechanics}
                    </g>
                `;
            }

            return `<svg viewBox="0 0 140 250" xmlns="http://www.w3.org/2000/svg"><g transform="translate(70, 20)">${svgContent}</g></svg>`;
        }

        // DIRT SVG
        const dirtSVG = `
        <svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
            <defs>
                <linearGradient id="gradDirt" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#795548;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#5d4037;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path d="M10,60 L190,60 C190,60 200,40 180,30 C160,20 140,40 100,35 C60,30 40,20 20,30 C0,40 10,60 10,60 Z" fill="url(#gradDirt)"/>
            <path d="M20,30 L25,15 L30,30" fill="#00b894"/>
            <path d="M170,30 L175,15 L180,30" fill="#00b894"/>
            <path d="M100,35 L105,20 L110,35" fill="#00b894"/>
        </svg>`;

        document.querySelectorAll('.dirt-container').forEach(el => el.innerHTML = dirtSVG);

        // --- GAME LOGIC ---
        const holes = document.querySelectorAll('.hole');
        const scoreBoard = document.querySelector('#score');
        const highScoreBoard = document.querySelector('#high-score');
        const timerDisplay = document.querySelector('#timer');
        const overlay = document.getElementById('overlay');
        const startContent = document.getElementById('start-content');
        const inputContent = document.getElementById('input-content');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const leaderboardList = document.getElementById('leaderboard-list');
        const usernameInput = document.getElementById('username');

        let lastHole;
        let timeUp = false;
        let score = 0;
        let countdown;
        let minTime = CONFIG.START_MIN_TIME;
        let maxTime = CONFIG.START_MAX_TIME;
        
        // --- STORAGE ---
        function getLeaderboard() {
            const stored = localStorage.getItem('whackZooScores');
            return stored ? JSON.parse(stored) : [];
        }
        function saveLeaderboard(scores) { localStorage.setItem('whackZooScores', JSON.stringify(scores)); }
        function isHighScore(currentScore) {
            const scores = getLeaderboard();
            if (scores.length < 5) return true;
            return currentScore > scores[scores.length - 1].score;
        }
        function displayTopScore() {
            const scores = getLeaderboard();
            highScoreBoard.textContent = scores.length > 0 ? scores[0].score : 0;
        }
        displayTopScore();

        function renderLeaderboard() {
            const scores = getLeaderboard();
            if(scores.length === 0) {
                leaderboardList.innerHTML = '<li class="leaderboard-item">No scores yet!</li>';
                return;
            }
            leaderboardList.innerHTML = scores.map((s, i) => `
                <li class="leaderboard-item">
                    <span>${i+1}. ${s.name}</span>
                    <span>${s.score}</span>
                </li>
            `).join('');
        }

        // --- AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'pop') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'raspberry') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                const ampOsc = audioCtx.createOscillator();
                ampOsc.type = 'square';
                ampOsc.frequency.value = 25; 
                const ampGain = audioCtx.createGain();
                ampGain.gain.value = 0.5;
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- GAMEPLAY ---

        function randomTime(min, max) {
            return Math.round(Math.random() * (max - min) + min);
        }

        function randomHole(holes) {
            const idx = Math.floor(Math.random() * holes.length);
            const hole = holes[idx];
            if (hole === lastHole) return randomHole(holes);
            lastHole = hole;
            return hole;
        }

        function peep() {
            let time = randomTime(minTime, maxTime);
            const hole = randomHole(holes);
            const container = hole.querySelector('.animal-container');
            
            // 1. CHOOSE ANIMAL
            let animalType;
            let isUnicorn = false;

            // Updated probability: 1 in 25 (0.04)
            if (Math.random() < 0.04) {
                animalType = 'unicorn';
                isUnicorn = true;
            } else {
                // Equal chance for others (5 types)
                const animals = ['bunny', 'giraffe', 'monkey', 'rhino', 'dog'];
                animalType = animals[Math.floor(Math.random() * animals.length)];
            }

            // 2. CHOOSE ACCESSORY
            const randAcc = Math.random();
            container.classList.remove('type-party', 'type-crown');
            
            container.dataset.variant = 'normal';

            if (randAcc < CONFIG.PROB_CROWN) {
                container.classList.add('type-crown');
                container.dataset.variant = 'crown';
                time = time * CONFIG.MOD_CROWN_TIME;
            } else if (randAcc < (CONFIG.PROB_CROWN + CONFIG.PROB_PARTY)) {
                container.classList.add('type-party');
                container.dataset.variant = 'party';
                time = time * CONFIG.MOD_PARTY_TIME;
            }

            // 3. INJECT SVG & DATA
            container.innerHTML = getAnimalSVG(animalType);
            container.dataset.animal = animalType;

            hole.classList.add('up');
            playSound('pop');

            setTimeout(() => {
                hole.classList.remove('up');
                if (!timeUp) peep();
            }, time);
        }

        function startGame() {
            scoreBoard.textContent = 0;
            score = 0;
            timeUp = false;
            minTime = CONFIG.START_MIN_TIME;
            maxTime = CONFIG.START_MAX_TIME;
            
            startContent.style.display = 'none';
            inputContent.style.display = 'none';
            leaderboardContent.style.display = 'none';
            overlay.classList.add('hidden');
            
            let timeLeft = CONFIG.GAME_DURATION;
            timerDisplay.textContent = timeLeft;
            peep();

            countdown = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(countdown);
                    timeUp = true;
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            overlay.classList.remove('hidden');
            if (isHighScore(score) && score > 0) {
                inputContent.style.display = 'flex';
                usernameInput.value = '';
                usernameInput.focus();
            } else {
                showLeaderboardScreen();
            }
        }

        function submitScore() {
            const name = usernameInput.value.trim() || "Anon";
            const scores = getLeaderboard();
            const newEntry = { name: name, score: score };
            scores.push(newEntry);
            scores.sort((a, b) => b.score - a.score);
            scores.splice(5); 
            saveLeaderboard(scores);
            displayTopScore();
            inputContent.style.display = 'none';
            showLeaderboardScreen();
        }

        function showLeaderboardScreen() {
            startContent.style.display = 'none';
            renderLeaderboard();
            leaderboardContent.style.display = 'block';
        }

        function resetToStart() {
            leaderboardContent.style.display = 'none';
            startContent.style.display = 'block';
        }

        function whack(e) {
            if(!e.isTrusted) return;
            const hole = this.parentNode;
            if(hole.classList.contains('bonked')) return;

            const container = this;
            const animal = container.dataset.animal;
            const variant = container.dataset.variant;
            
            let points = 1;

            if (variant === 'party') points = 2;
            if (variant === 'crown') points = 3;

            // Unicorn Multiplier
            if (animal === 'unicorn') {
                points = points * 3; // 3, 6, 9
            }

            score += points;
            scoreBoard.textContent = score;
            
            hole.classList.remove('up');
            hole.classList.add('bonked');
            playSound('raspberry');

            const float = document.createElement('div');
            float.classList.add('float-score');
            float.classList.add(`score-${points}`); // Add class for color
            float.textContent = "+" + points;
            
            const x = e.clientX || hole.getBoundingClientRect().left + 50;
            const y = e.clientY || hole.getBoundingClientRect().top;
            float.style.left = `${x}px`;
            float.style.top = `${y}px`;
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 800);

            if (minTime > CONFIG.END_MIN_TIME_LIMIT) minTime -= CONFIG.SPEED_DECREMENT;
            if (maxTime > CONFIG.END_MAX_TIME_LIMIT) maxTime -= CONFIG.SPEED_DECREMENT;

            setTimeout(() => {
                hole.classList.remove('bonked');
            }, 400);
        }

        document.querySelectorAll('.animal-container').forEach(g => {
            g.addEventListener('mousedown', whack);
            g.addEventListener('touchstart', (e) => { e.preventDefault(); whack.call(g, e); });
        });

    </script>
</body>
</html>